#!/usr/bin/env -S unshare -rm --map-auto sh

if [ "$#" -eq "0" ]
then
	echo "USAGE: $0 <mountpoint> [cmdline]..."
	exit 1
fi

dir="$1"
shift
[ -e "$dir" ] || mkdir "$dir"
if [ -n "`ls "$dir"`" ]
then
	nonempty="true"
else
	mount -t tmpfs none "$dir"
	nonempty="false"
fi
cd "$dir"

ln -sf lib/x86_64-linux-gnu lib64
if [ -d bin ]
then
	ln -sf ../usr/bin/sh bin
	ln -sf "../usr/bin/`basename "$SHELL"`" bin
else
	ln -sf usr/bin .
fi

mkdir -p dev
mkdir -p etc
mkdir -p lib
mkdir -p usr
mount -R /dev dev
mount -Bo ro /etc etc
mount -Bo ro /lib lib
mount -Bo ro,nosuid /usr usr

mkdir -p home
mkdir -p proc
mkdir -p tmp
mount -t tmpfs none home
mount -t tmpfs none tmp
cp -r etc/skel home/nobody

if "$nonempty"
then
	chown nobody: .
else
	mount -o remount,ro none .
fi

exec env -i HOME=/home/nobody PATH="$PATH" SHELL="$SHELL" TERM="$TERM" unshare -UR. -pf --mount-proc "$@"
